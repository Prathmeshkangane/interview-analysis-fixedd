<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview in Progress - AI Mock Interview</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body class="interview-page">
    <div class="interview-container">
        <!-- Left Panel: Video and Question -->
        <div class="left-panel">
            <!-- Video Section -->
            <div class="video-section">
                <video id="videoElement" autoplay muted></video>
                <div class="video-status" id="videoStatus">
                    <div id="recordingIndicator" class="hidden">
                        üî¥ Recording...
                    </div>
                </div>
            </div>

            <!-- Question Display -->
            <div class="question-display">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">Question 1 of 5</span>
                    <span class="question-category" id="questionCategory">Resume-Based</span>
                </div>
                <div class="question-text" id="questionText">
                    Loading question...
                </div>
                <div class="question-focus" id="questionFocus"></div>
            </div>
        </div>

        <!-- Right Panel: Controls and Transcript -->
        <div class="right-panel">
            <div class="controls-section">
                <h3>Interview Controls</h3>

                <!-- Recording Controls -->
                <div class="recording-controls">
                    <button id="startRecording" class="btn-record" disabled>
                        üé§ Start Recording
                    </button>
                    <button id="stopRecording" class="btn-stop" disabled style="display: none;">
                        ‚èπÔ∏è Stop Recording
                    </button>
                    <div class="recording-timer" id="recordingTimer">00:00</div>
                </div>

                <div class="status-message" id="statusMessage">
                    Loading interview...
                </div>

                <!-- Transcript Display -->
                <div class="transcript-section">
                    <h4>Your Answer:</h4>
                    <div id="transcript" class="transcript-box">
                        <em>Your answer will appear here as you speak...</em>
                    </div>
                    <div id="wordCount" class="word-count">Words: 0</div>
                </div>

                <!-- Submit Button -->
                <button id="submitAnswer" class="btn-submit" disabled style="display: none;">
                    Submit Answer & Continue
                </button>

                <!-- Feedback Display -->
                <div id="feedbackSection" class="feedback-section" style="display: none;">
                    <h4>Quick Feedback:</h4>
                    <div class="score-display">
                        Score: <span id="answerScore">0</span>/100
                    </div>
                    <ul id="feedbackList"></ul>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-section">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0 of 5 questions completed</div>
            </div>
        </div>
    </div>

    <script>
        const sessionId = '{{ session_id }}';
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let timerInterval;
        let currentTranscript = '';
        let recognition;
        let isRecording = false;

        // Safe DOM helper functions
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element not found: ${id}`);
            }
            return element;
        }

        function safeSetText(id, text) {
            const element = safeGetElement(id);
            if (element) {
                element.textContent = text;
            }
        }

        function safeSetHTML(id, html) {
            const element = safeGetElement(id);
            if (element) {
                element.innerHTML = html;
            }
        }

        function safeSetStyle(id, styles) {
            const element = safeGetElement(id);
            if (element) {
                Object.assign(element.style, styles);
            }
        }

        function safeToggleClass(id, className, add) {
            const element = safeGetElement(id);
            if (element && element.classList) {
                if (add) {
                    element.classList.add(className);
                } else {
                    element.classList.remove(className);
                }
            }
        }

        function safeSetDisabled(id, disabled) {
            const element = safeGetElement(id);
            if (element) {
                element.disabled = disabled;
            }
        }

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    currentTranscript += finalTranscript;
                }

                const fullText = currentTranscript + interimTranscript;
                safeSetText('transcript', fullText || 'Listening...');

                // Update word count
                const wordCount = fullText.trim().split(/\s+/).filter(w => w.length > 0).length;
                safeSetText('wordCount', `Words: ${wordCount}`);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    safeSetHTML('transcript', '<em>No speech detected. Please try again.</em>');
                } else if (event.error === 'aborted') {
                    console.log('Recognition stopped');
                }
            };

            recognition.onend = () => {
                console.log('Recognition ended');
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('Recognition restart failed:', e);
                    }
                }
            };
        } else {
            alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
        }

        // Initialize video
        async function initVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                const videoElement = safeGetElement('videoElement');
                if (videoElement) {
                    videoElement.srcObject = stream;
                }
                safeSetText('videoStatus', '‚úÖ Camera Ready');

                // Load first question
                loadQuestion();
            } catch (error) {
                console.error('Error accessing camera:', error);
                safeSetText('videoStatus', '‚ùå Camera Error');
                alert('Please allow camera and microphone access to continue.');
            }
        }

        // Load current question
        async function loadQuestion() {
            try {
                safeSetText('statusMessage', 'Loading question...');

                const response = await fetch(`/api/get-question/${sessionId}`);
                const data = await response.json();

                if (data.completed) {
                    window.location.href = `/results/${sessionId}`;
                    return;
                }

                // Update question display
                safeSetText('questionNumber', `Question ${data.question_number} of ${data.total_questions}`);
                safeSetText('questionCategory', data.category || 'Resume-Based');
                safeSetText('questionText', data.question);
                safeSetText('questionFocus', data.focus_area || '');

                // Update progress
                const progress = ((data.question_number - 1) / data.total_questions) * 100;
                safeSetStyle('progressFill', { width: `${progress}%` });
                safeSetText('progressText', `${data.question_number - 1} of ${data.total_questions} questions completed`);

                // Enable recording
                safeSetDisabled('startRecording', false);
                safeSetText('statusMessage', 'Ready to record your answer');

                // Speak the question
                speakQuestion(data.question);

            } catch (error) {
                console.error('Error loading question:', error);
                safeSetText('statusMessage', 'Error loading question: ' + error.message);
            }
        }

        // Text-to-speech for question
        function speakQuestion(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            }
        }

        // Start recording
        const startRecordingBtn = safeGetElement('startRecording');
        if (startRecordingBtn) {
            startRecordingBtn.addEventListener('click', async () => {
                try {
                    console.log('Start recording clicked');

                    // Reset transcript
                    currentTranscript = '';
                    safeSetText('transcript', 'Listening...');
                    safeSetText('wordCount', 'Words: 0');
                    safeSetStyle('feedbackSection', { display: 'none' });

                    if (recognition && !isRecording) {
                        isRecording = true;
                        try {
                            recognition.start();
                            console.log('Speech recognition started');
                        } catch (e) {
                            console.error('Failed to start recognition:', e);
                            isRecording = false;
                        }
                    }

                    // Update UI
                    safeSetStyle('startRecording', { display: 'none' });
                    safeSetStyle('stopRecording', { display: 'block' });
                    safeSetDisabled('stopRecording', false);
                    safeToggleClass('recordingIndicator', 'hidden', false);
                    safeSetText('statusMessage', 'üé§ Recording... Speak your answer clearly');

                    // Start timer
                    recordingStartTime = Date.now();
                    timerInterval = setInterval(updateTimer, 1000);

                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Error starting recording: ' + error.message);
                    isRecording = false;
                }
            });
        }

        // Stop recording
        const stopRecordingBtn = safeGetElement('stopRecording');
        if (stopRecordingBtn) {
            stopRecordingBtn.addEventListener('click', () => {
                console.log('Stop recording clicked');

                // Stop speech recognition
                isRecording = false;
                if (recognition) {
                    try {
                        recognition.stop();
                        console.log('Speech recognition stopped');
                    } catch (e) {
                        console.log('Error stopping recognition:', e);
                    }
                }

                // Stop timer
                clearInterval(timerInterval);

                // Update UI
                safeSetStyle('stopRecording', { display: 'none' });
                safeToggleClass('recordingIndicator', 'hidden', true);
                safeSetText('statusMessage', 'Processing your answer...');

                // Show submit button
                if (currentTranscript.trim().length > 0) {
                    safeSetStyle('submitAnswer', { display: 'block' });
                    safeSetDisabled('submitAnswer', false);
                    safeSetText('statusMessage', 'Review your answer and click Submit');
                } else {
                    safeSetText('statusMessage', 'No speech detected. Please try again.');
                    safeSetStyle('startRecording', { display: 'block' });
                    safeSetDisabled('startRecording', false);
                }
            });
        }

        // Submit answer
        const submitAnswerBtn = safeGetElement('submitAnswer');
        if (submitAnswerBtn) {
            submitAnswerBtn.addEventListener('click', async () => {
                const answer = currentTranscript.trim();

                if (!answer) {
                    alert('Please record an answer first');
                    return;
                }

                safeSetDisabled('submitAnswer', true);
                safeSetText('statusMessage', 'Analyzing your answer...');

                try {
                    const duration = (Date.now() - recordingStartTime) / 1000;

                    const response = await fetch(`/api/submit-answer/${sessionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            answer: answer,
                            duration: duration
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Show feedback
                        safeSetText('answerScore', data.score.toFixed(1));
                        const feedbackList = safeGetElement('feedbackList');
                        if (feedbackList) {
                            feedbackList.innerHTML = '';
                            data.feedback.forEach(fb => {
                                const li = document.createElement('li');
                                li.textContent = fb;
                                feedbackList.appendChild(li);
                            });
                        }
                        safeSetStyle('feedbackSection', { display: 'block' });

                        // Wait 3 seconds then move to next question
                        safeSetText('statusMessage',
                            data.is_complete ? 'Interview complete! Redirecting...' : 'Loading next question...');

                        setTimeout(() => {
                            if (data.is_complete) {
                                window.location.href = `/results/${sessionId}`;
                            } else {
                                // Reset for next question
                                safeSetStyle('submitAnswer', { display: 'none' });
                                safeSetStyle('startRecording', { display: 'block' });
                                safeSetText('recordingTimer', '00:00');
                                safeSetHTML('transcript', '<em>Your answer will appear here as you speak...</em>');
                                safeSetText('wordCount', 'Words: 0');
                                loadQuestion();
                            }
                        }, 3000);
                    } else {
                        alert('Error submitting answer: ' + (data.error || 'Unknown error'));
                        safeSetDisabled('submitAnswer', false);
                    }
                } catch (error) {
                    console.error('Error submitting answer:', error);
                    alert('Error submitting answer: ' + error.message);
                    safeSetDisabled('submitAnswer', false);
                }
            });
        }

        // Update recording timer
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            safeSetText('recordingTimer',
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            initVideo();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            isRecording = false;
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('Cleanup error:', e);
                }
            }
        });
    </script>
</body>

</html>